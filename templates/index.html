<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Costo terreni - Contee USA</title>

  <!-- PWA manifest + colori tema -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <meta name="theme-color" content="#003366">

  <!-- Icona app -->
  <link rel="icon" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />

  <style>
    html, body { height: 100%; margin: 0; }
    body{
      min-height: 100dvh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
      background-color: #f9f9f9;
    }
    .container{
      width: min(900px, 100%);
      background: #fff;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,.1);
      max-height: calc(100dvh - 32px);
      overflow: auto;
    }
    @media (max-width: 640px), (max-height: 600px){
      body{ align-items: flex-start; }
      .container{
        margin-top: 12px;
        max-height: none;
        overflow: visible;
        padding: 16px 18px;
      }
      .form-row label{ width: 120px; }
      .checks{ flex-wrap: wrap; gap: 12px; }
    }
    @media (max-width: 360px){
      .form-row label{ width: 100px; }
      .btn{ padding: 10px 16px; }
    }
    .messages { list-style:none; padding:0; margin-top:15px; }
    .messages li { padding:8px; border-radius:6px; margin-bottom:5px; }
    .messages li.info { background:#e0f0ff; color:#004488; }
    .messages li.success { background:#d4edda; color:#155724; }
    .messages li.error { background:#f8d7da; color:#721c24; }
    .alert.ok{
      background:#e8f5e9; color:#1b5e20;
      border:1px solid #c8e6c9; padding:10px 12px;
      border-radius:8px; margin-top:12px;
    }
    .alert.ok strong{ margin-right:6px; }
    .alert.ok .download-link{ font-weight:600; text-decoration:underline; margin-left:8px; }
    .header{ display:flex; align-items:center; gap:16px; margin-bottom:16px; }
    .logo{ height:48px; }
    .form-row{ display:flex; align-items:center; gap:12px; margin:12px 0; }
    .form-row label{ width:160px; }
    .input-pair{ display:flex; gap:12px; width:100%; }
    .checks{ display:flex; gap:18px; }
    select, input[type=number], input[type=text]{
      padding:10px;
      width:100%;
      max-width:340px;
    }
    .actions{
      display:flex;
      justify-content:center;
      align-items:center;
      position:relative;
      margin-top:20px;
      min-height:48px;
    }
    .center-btn{ text-align:center; }
    .side-btn{
      position:absolute;
      right:0;
    }
    .btn{
      cursor:pointer;
      border-radius:8px;
      padding:12px 22px;
      font-weight:600;
      border:none;
    }
    .btn-primary{
      background-color:#007bff;
      color:#fff;
      border:1px solid #007bff;
      transition:background-color .2s;
    }
    .btn-primary:hover{ background-color:#0056b3; }
    .btn-secondary.small-btn{
      background:transparent;
      color:#555;
      border:1px solid #aaa;
      font-size:.9rem;
      padding:8px 14px;
      transition:background-color .2s;
    }
    .btn-secondary.small-btn:hover{ background-color:#f0f0f0; }
  </style>
</head>

<body>
  <div class="container">

    <div class="header">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo">
      <h1>Ricerca costo terreni - Contee USA</h1>
    </div>

    <form method="POST" action="/run_scraper">
      <div class="form-row">
        <label for="access_code">Codice di accesso:</label>
        <input type="text"
               id="access_code"
               name="access_code"
               placeholder="Inserisci il codice che hai ricevuto"
               required>
      </div>

      <div class="form-row">
        <label for="state">Stato:</label>
        <select id="state" name="state" required>
          <option value="">-- Seleziona lo Stato --</option>
          {% for code, name in states_full %}
            <option value="{{ code }}">{{ name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-row">
        <label for="county">Contea:</label>
        <select id="county" name="county" required>
          <option value="">-- Seleziona la contea --</option>
        </select>
      </div>

      <div class="form-row">
        <label>Superficie (acri):</label>
        <div class="input-pair">
          <input type="number" name="min_acres" id="min_acres" placeholder="Min" min="0" max="100">
          <input type="number" name="max_acres" id="max_acres" placeholder="Max" min="0" max="100">
        </div>
      </div>

      <div class="form-row">
        <label>Includi:</label>
        <div class="checks">
          <label><input type="checkbox" name="include_forsale"> For Sale</label>
          <label><input type="checkbox" name="include_sold"> Sold</label>
        </div>
      </div>

      <div class="form-row">
        <label for="period">Periodo:</label>
        <select id="period" name="period">
          <option value="">-- Seleziona il periodo --</option>
          <option value="30gg">30 giorni</option>
          <option value="90gg">90 giorni</option>
          <option value="6M">6 mesi</option>
          <option value="12M">12 mesi</option>
        </select>
      </div>

      <div class="form-row">
        <label>Fonti:</label>
        <div class="checks">
          <!-- Realtor nascosto -->
          <label><input type="checkbox" name="use_zillow"> Zillow</label>
        </div>
      </div>

      <div class="actions">
        <div class="center-btn">
          <button type="submit" class="btn btn-primary">Avvia scraping</button>
        </div>
        <div class="side-btn">
          <button type="button" id="btn-reset" class="btn btn-secondary small-btn">Nuova ricerca</button>
        </div>
      </div>
    </form>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="messages">
          {% for category, msg in messages %}
            <li class="{{ category }}">{{ msg }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    {% if done %}
      {% if zillow_ready and zillow_url %}
        <div class="alert ok">
          <strong>[OK]</strong> File Zillow creato.
          <a class="download-link" href="{{ zillow_url }}" download>Premi qui per scaricare il file ⬇️</a>
        </div>
      {% endif %}
    {% endif %}
  </div>

  <script>
    const countiesByState = {{ counties_json | safe }};
    const stateSelect = document.getElementById('state');
    const countySelect = document.getElementById('county');

    stateSelect.addEventListener('change', () => {
      const s = stateSelect.value;
      const list = countiesByState[s] || [];
      countySelect.innerHTML = '<option value="">-- Seleziona la contea --</option>';
      list.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        countySelect.appendChild(opt);
      });
    });

    // Reset
    document.getElementById('btn-reset').addEventListener('click', function () {
      const form = document.querySelector('form');
      if (form) form.reset();
      document.querySelectorAll('.alert, .messages').forEach(el => el.remove());
      window.location.replace('/reset');
    });

    // --- PWA: registra il service worker ---
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function () {
        navigator.serviceWorker.register("/service-worker.js")
          .then(reg => console.log("[PWA] Service Worker registrato"))
          .catch(err => console.log("[PWA] Errore SW", err));
      });
    }
  </script>

</body>
</html>
